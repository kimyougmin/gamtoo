import { useState, useEffect } from "react";
import { parseStringPromise } from "xml2js";
import { parseISO } from "date-fns";
import dayjs from "dayjs";
import {
  ChevronUpIcon,
  ChevronDownIcon,
  CheckIcon,
} from "@heroicons/react/20/solid";
import Image from "next/image";
export default function CultureFestival() {
  interface Item {
    seqNo: string;
    subTitle: string;
    eDate: string;
    imageUrl: string;
  }
  const [currentData, setCurrentData] = useState<Item[]>([]);
  const [festivalItems, setFestivalItems] = useState<Item[]>([]);
  function NotFound() {
    return (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="317"
        height="242"
        fill="none"
      >
        <path
          fill="#F2F6FB"
          d="M315.55 18.5693H160.416c-.801 0-1.45.6876-1.45 1.5356V210.265c0 .848.649 1.535 1.45 1.535H315.55c.801 0 1.45-.687 1.45-1.535V20.1049c0-.848-.649-1.5356-1.45-1.5356Z"
        />
        <path
          fill="#D8DEED"
          d="M190.108 39.0435v1.5356h-18.333c-.136 0-.244.1141-.244.2556h-1.449c0-.99.757-1.7912 1.693-1.7912h18.333Zm22.715 0v1.5356h-19.815v-1.5356h19.815Zm22.714 0v1.5356h-19.814v-1.5356h19.814Zm22.715 0v1.5356h-19.815v-1.5356h19.815Zm22.714 0v1.5356h-19.815v-1.5356h19.815Zm22.714 0v1.5356h-19.814v-1.5356h19.814Zm2.446 23.4837h-1.45V41.5406h1.45v20.9866Zm-7.402 18.2336v-1.5356h5.709c.135 0 .243-.1141.243-.2557v-13.371h1.45v13.371c0 .99-.757 1.7913-1.693 1.7913h-5.709Zm-22.715 0v-1.5356h19.815v1.5356h-19.815Zm-22.714 0v-1.5356h19.815v1.5356h-19.815Zm-22.715 0v-1.5356h19.815v1.5356H230.58Zm-22.714 0v-1.5356h19.815v1.5356h-19.815Zm-22.714 0v-1.5356h19.814v1.5356h-19.814Zm-15.07-10.1127h1.449v8.3214c0 .1409.109.2557.244.2557h10.477v1.5356h-10.477c-.935 0-1.693-.8016-1.693-1.7913v-8.3214Zm0-24.0578h1.449v20.9866h-1.449V46.5903Zm0-5.7556h1.449v2.6844h-1.449v-2.6844ZM158.966 21.3854c0-2.8276 2.163-5.1198 4.832-5.1198h148.37c2.669 0 4.832 2.2925 4.832 5.1198v6.1414H158.966v-6.1414Z"
        />
        <path
          fill="#FF5645"
          d="M166.094 24.4555c1.268 0 2.296-1.0885 2.296-2.4313 0-1.3429-1.028-2.4314-2.296-2.4314-1.267 0-2.295 1.0885-2.295 2.4314 0 1.3428 1.028 2.4313 2.295 2.4313Z"
        />
        <path
          fill="#FFCB3D"
          d="M173.585 24.4555c1.268 0 2.296-1.0885 2.296-2.4313 0-1.3429-1.028-2.4314-2.296-2.4314-1.267 0-2.295 1.0885-2.295 2.4314 0 1.3428 1.028 2.4313 2.295 2.4313Z"
        />
        <path
          fill="#3ABF7C"
          d="M181.318 24.4555c1.268 0 2.296-1.0885 2.296-2.4313 0-1.3429-1.028-2.4314-2.296-2.4314-1.268 0-2.296 1.0885-2.296 2.4314 0 1.3428 1.028 2.4313 2.296 2.4313Z"
        />
        <path
          fill="#E1E5F0"
          d="M170.104 91.7647c0-.5644.43-1.022.967-1.022h133.143c.534 0 .967.4564.967 1.022v43.3263c0 .564-.43 1.022-.967 1.022H171.071c-.534 0-.967-.456-.967-1.022V91.7647Zm.461 52.4683h51.47c.267 0 .483.229.483.512v6.142c0 .283-.216.512-.483.512h-51.47c-.267 0-.483-.229-.483-.512v-6.142c0-.283.216-.512.483-.512Zm0 11.773h36.488c.267 0 .483.229.483.512v6.142c0 .283-.216.512-.483.512h-36.488c-.267 0-.483-.229-.483-.512v-6.142c0-.283.216-.512.483-.512Zm0 12.029h43.979c.267 0 .483.229.483.512v6.142c0 .283-.216.512-.483.512h-43.979c-.267 0-.483-.229-.483-.512v-6.142c0-.283.216-.512.483-.512Zm0 11.773h28.997c.267 0 .483.229.483.512v6.142c0 .283-.216.512-.483.512h-28.997c-.267 0-.483-.229-.483-.512v-6.142c0-.283.216-.512.483-.512Zm67.418-23.802h53.161c.267 0 .484.229.484.512v6.142c0 .283-.217.512-.484.512h-53.161c-.267 0-.483-.229-.483-.512v-6.142c0-.283.216-.512.483-.512Zm0 12.029h59.927c.267 0 .484.229.484.512v6.142c0 .283-.217.512-.484.512h-59.927c-.267 0-.483-.229-.483-.512v-6.142c0-.283.216-.512.483-.512Zm0 11.773h66.693c.267 0 .484.229.484.512v6.142c0 .283-.217.512-.484.512h-66.693c-.267 0-.483-.229-.483-.512v-6.142c0-.283.216-.512.483-.512Zm0 11.773h46.395c.267 0 .484.229.484.512v6.142c0 .283-.217.512-.484.512h-46.395c-.267 0-.483-.229-.483-.512v-6.142c0-.283.216-.512.483-.512Zm.022-47.301h66.693c.267 0 .483.229.483.511v6.236c0 .283-.216.512-.483.512h-66.693c-.267 0-.483-.229-.483-.512v-6.236c0-.282.216-.511.483-.511Z"
        />
        <path
          fill="#fff"
          fillRule="evenodd"
          d="m239.209 122.455-1.001.013.007-.013h-12.253c-.268 0-.371-.194-.23-.434l8.679-14.759c.141-.24.376-.242.522-.007l6.257 10.131 2.406-4.099c.141-.241.377-.249.528-.015l5.536 8.515c.151.232.059.428-.21.436l-5.101.168-.218.002.035.062H239.209Zm4.84-12.925c-1.104 0-1.998-.955-1.998-2.134 0-1.179.894-2.135 1.998-2.135 1.103 0 1.998.956 1.998 2.135 0 1.179-.895 2.134-1.998 2.134Z"
          clipRule="evenodd"
        />
        <path
          fill="#FFCB3D"
          d="M35.1244 239.697h24.6475c.6005 0 1.0874.515 1.0874 1.151 0 .637-.4869 1.152-1.0874 1.152H35.1244c-.6006 0-1.0874-.515-1.0874-1.152 0-.636.4868-1.151 1.0874-1.151Zm76.3586 0h41.079c.601 0 1.088.515 1.088 1.151 0 .637-.487 1.152-1.088 1.152h-41.079c-.6 0-1.087-.515-1.087-1.152 0-.636.487-1.151 1.087-1.151Z"
        />
        <path
          fill="#474961"
          d="M152.687 239.704a1.036 1.036 0 0 0-.125-.007h-41.079c-.07 0-.14.007-.207.02l1.941-16.398h18.172l4.326 3.379c.99 1.049 2.078 1.996 3.238 2.841 2.827 1.996 4.301 1.97 8.602 4.171 1.16.589 2.271 1.229 3.383 1.971.532.512 1.474 1.536 1.764 2.764.048.205.048.41.072.589 0 .239-.033.463-.087.67Zm-92.6049.04a1.0289 1.0289 0 0 0-.3102-.047H35.1244c-.0642 0-.127.006-.1881.017l5.837-15.87 17.3016 2.483 2.0072 13.417Z"
        />
        <path
          fill="#8F4AFF"
          d="m52.1874 155.555-.3115-.072c5.582-34.478 9.8375-55.141 12.7667-61.9863 2.9292-6.8458 6.3813-11.6936 10.3565-14.5432 3.7933-4.5777 10.4836-4.3226 19.7386-4.6097.2351-.0115.5021-.0089.7372-.0208 9.5691-.1712 7.9771.2162 10.5041 1.0441 12.123 3.4296 22.18 25.0889 30.17 64.9779l2.54 13.066a8.9984 8.9984 0 0 0-.112-.316c.069.337.103.68.101 1.027.255 5.582-3.835 9.957-12.272 13.125-5.154 1.935-15.242 7.261-31.8266 8.942-7.0409.713-20.1804.558-39.4185-.465-3.1793-5.656-4.5397-10.184-4.0813-13.583.2512-1.863.6205-4.058 1.1078-6.586Z"
        />
        <path
          fill="#444"
          d="M52.1745 155.622c28.2624 6.493 49.1455 5.991 62.6505-1.505 13.241-7.35 21.153-7.714 23.737-1.094.079.36.118.727.116 1.099.255 5.582-3.835 9.957-12.272 13.125-5.154 1.935-15.242 7.261-31.8266 8.941-7.0409.714-20.1804.559-39.4185-.464-3.1793-5.656-4.5397-10.184-4.0813-13.583.2489-1.847.6139-4.02 1.0949-6.519Z"
          opacity=".177"
        />
        <path
          fill="#FF5678"
          d="M77.9027 54.4949c-2.7054-.4412-4.8756-.9116-6.5107-1.4112-1.3401-.1995-3.3883-.7628-4.1915-2.4331-1.1705-2.3969.972-5.6704 3.3631-9.3463 2.8782-4.4046 4.6416-5.9933 7.4155-8.0712 4.7222-3.5374 7.6384-3.6746 9.754-1.3987.2129.2291.4248.6081.6357 1.137a10.99 10.99 0 0 1 1.8477-.127l5.3161.1024c6.7414.0767 12.1064 6.1936 12.0094 13.5901v.4607l-.145 14.2555-.13 6.6755c-.09 4.5954-3.633 8.2711-7.9726 8.2711H85.7385a6.542 6.542 0 0 1-.0886-.0005c-4.4037-.0518-7.934-3.8748-7.8852-8.5391l.138-13.1652Z"
        />
        <path
          fill="#D8DEED"
          d="M188.183 61.2822 5.7517 51.1559c-1.3327-.074-2.4697 1.0104-2.5395 2.4219L.1264 115.94c-.0699 1.412.954 2.616 2.2866 2.69l182.431 10.126c1.333.074 2.47-1.01 2.54-2.421l3.086-62.363c.069-1.4115-.954-2.6158-2.287-2.6898Z"
        />
        <path
          fill="#fff"
          d="M126.894 77.3578 12.9953 71.0355c-.5331-.0296-.9879.4041-1.0159.9688l-.607 12.268c-.0279.5646.3816 1.0463.9147 1.0759l113.8989 6.3223c.533.0296.988-.4042 1.016-.9688l.607-12.268c.028-.5646-.382-1.0463-.915-1.0759Z"
        />
        <path
          fill="#ED9474"
          d="m97.4509 29.4065-.3153 4.2514c-.0155.2092-.15.3872-.3393.4491-1.0558.3449-2.0822.4702-3.0792.3759-1.0254-.097-2.534-.4866-4.5256-1.1686-.2361-.0808-.376-.3378-.3238-.5946l1.6013-7.8883.094.0282c-.8789-1.8801-1.4354-2.932-1.6698-3.1556-.8915-.9044-1.5956-6.4873 2.3777-6.1507.4377.0027.8639.1354 1.2737.3471l.0265.0228c.1328.1139.3036.1206.4743.1274.4085-.0455.7147-.3884.6958-.8238l-.443-6.6674c-.0429-.4327.2392-.773.6477-.8184.8892-.099 1.7493-.2462 2.6183-.5488.1201-.0134.2137-.0495.3099-.0602.855-.1982 5.4629-1.02 8.3229 2.3417.252.3323.504.6645.707 1.0021.524.8682.817 1.8649.851 2.942l.195 4.6619c-.002.4635-.005.927-.053 1.4213-.585 5.8554-2.642 10.099-4.696 10.4564-1.055.1431-2.125.1336-3.1915-.0823-.1354-.0538-.0483-.0094-1.5586-.4686ZM76.4284 159.653l-18.3535 66.674-17.3016-2.482 11.1027-68.362.0549.004-.0124.076c8.8993 2.054 17.0692 3.418 24.5099 4.09Zm32.2966-2.801c2.177-.774 4.211-1.686 6.1-2.735 13.006-7.219 20.87-7.699 23.594-1.44 1.558 5.258 2.003 10.056 1.337 14.394-2.001 13.024-4.79 31.773-8.367 56.249h-18.172l.315-54.949-4.807-11.519ZM68.1118 51.722c.9757.8466 2.3545 1.1933 3.3458 1.3408 3.0071.9188 7.824 1.7389 14.4508 2.4601L82.472 69.7677l21.766 8.2424c.107.024.615.239 1.524.645 9.438 2.8473 15.724 5.428 18.86 7.742 2.432 1.7943 1.938 4.1427-1.481 7.045-2.722 2.3099-6.372 2.978-9.668 1.7692l-14.0669-5.1597.0022-.0546c-17.6314-2.0356-28.2453-6.0497-31.8416-12.0423-3.318-5.529-3.1364-14.2732.5451-26.2327Zm54.4432 5.9528c5.817-6.3377 11.141-7.3571 15.973-3.0584 4.831 4.2988-.493 5.3183-15.973 3.0584Z"
        />
        <path
          fill="#482D1F"
          d="M83.7677 18.9533c-.7326.3073-1.4569.4255-2.1731.3546-4.739-.4689-7.9511-4.8786-9.2197-9.1891-1.2687-4.3105.9602-6.5219 4.5261-8.9337 3.566-2.4119 7.6481-.6923 11.0512 1.172 1.989 1.0896 3.1559 2.9797 3.5006 5.6702a42.5702 42.5702 0 0 0 1.7963-.2088c.769-.0856 1.6265-.3068 3.0533-.62.1201-.0134.7963-.1903.8924-.201.8551-.1981 5.1692-.8627 8.0292 2.4989-.016.079-.756 0-2.921 1.5223-2.4652 1.7339-4.8945 9.3327-7.0687 9.2144-.0238-.0005-.0728.025-.1468.0764l.0962-.0965-1.3314-2.8884c-.301-.5841-.7575-1.0223-1.2785-1.376-.4098-.2117-.836-.3444-1.2737-.3472-1.1636.0266-2.3198 1.1075-2.6767 2.4082-.3328 1.298.0224 2.6739.9595 3.5475.5919.5775 1.3557.9299 2.164.9943l.9825-.1292-.1205.1142-2.5129 4.1985-2.1765-.6207c-1.7831-.6538-3.1671-3.0407-4.1518-7.1609Zm19.6603-1.8455c-.468.1808-1.224.3937-1.915.2904-1.155-.1288-.168-.9592.86-1.1251.479-.079.883.0818 1.144.2587.186.1594.146.4984-.089.576Zm4.076-.5566c-.463.2317-1.188.5183-1.895.494-1.195-.0471-.267-.9739.73-1.2136.521-.1352.899.0029 1.181.1516.231.1287.216.4649-.016.568ZM102.08 20.423c-.27-.2787-.245-1.0021-.216-1.4429-.008-.3335.26-.5693.524-.5987.171.0067.397.0845.481.4355.251.8212-.426 2.0803-.789 1.6061Zm3.963-.4669c-.222-.2841-.245-1.0021-.216-1.4428-.009-.3336.259-.5693.524-.5987.171.0067.397.0844.48.4354.252.8212-.449 2.083-.788 1.6061ZM105.61 18.0577c.004-.1413-.101-.2593-.234-.2636-.134-.0042-.245.1069-.249.2482l-.043 1.5231.001.0321.243 2.7c-.006.0312-.026.0537-.057.0605a118.294 118.294 0 0 0-1.119.0001c-.134.0005-.241.1156-.241.2569.001.1413.109.2555.243.255.463-.0019.84-.0019 1.131 0l.027-.0014c.281-.0313.484-.2676.501-.5539l-.001-.0398-.245-2.7102.043-1.507ZM104.16 24.9784c-.17-.0068-.613-.0604-.737-.3297-.005-.0509-.061-.1219-.042-.1755.06-.1353.805-.2182.805-.2182.988-.0843 1.223-.1619 1.308-.0427.031.0737.041.1755-.104.4233-.173.4568-.96.3642-1.23.3428Z"
        />
        <path
          fill="#474BFF"
          d="m142.152 78.2048 33.19 1.8423c1.614.0896 2.19.3 2.763.6669.574.3669 1.012.8829 1.297 1.5251.285.6423.422 1.2713.337 2.9803l-.222 4.4834c-.084 1.7089-.283 2.3193-.629 2.9265-.347.6073-.834 1.0719-1.44 1.3733-.607.3014-1.2.4468-2.814.3573l-33.19-1.8424c-1.614-.0895-2.19-.2999-2.763-.6668-.574-.3669-1.012-.8829-1.297-1.5252-.285-.6422-.422-1.2713-.337-2.9802l.222-4.4834c.084-1.7089.283-2.3193.629-2.9265.347-.6073.834-1.0719 1.44-1.3733.607-.3014 1.2-.4468 2.814-.3573Z"
        />
        <path
          fill="#F2F6FB"
          d="m106.929 102.849-69.7385-3.871c-.2665-.0148-.4939.202-.5079.4843l-.3541 7.1567c-.014.282.1908.523.4573.538l69.7392 3.871c.266.014.494-.202.508-.485l.354-7.156c.014-.282-.191-.523-.458-.538ZM152.076 105.538l-39.575-2.196c-.266-.015-.494.202-.508.484l-.354 7.156c-.014.283.191.524.457.538l39.575 2.197c.267.015.494-.202.508-.484l.354-7.157c.014-.282-.19-.523-.457-.538Z"
        />
        <path
          fill="#482D1F"
          d="M121.093 94.2383c.185.0793.396-.0158.471-.2124.075-.1966-.015-.4203-.2-.4996-1.166-.4983-2.084-.8548-4.136-1.6251-2.043-.7667-2.954-1.1207-4.107-1.6135-.185-.0793-.397.0158-.472.2124-.074.1966.015.4203.201.4997 1.166.4982 2.084.8548 4.136 1.6251 2.042.7666 2.953 1.1206 4.107 1.6134Zm3.609-2.7453c.19.067.395-.0417.458-.2429.064-.2011-.039-.4185-.229-.4855-1.301-.459-2.302-.8389-4.525-1.7035-2.229-.8674-3.235-1.2491-4.545-1.7113-.19-.067-.395.0418-.459.2429-.063.2012.04.4186.23.4856 1.301.4589 2.302.8388 4.524 1.7035 2.23.8673 3.236 1.249 4.546 1.7112ZM89.2301 54.7923c1.8225-5.2655 2.8813-9.0415 3.1774-11.3453.027-.2101-.1119-.4036-.3102-.4322-.1984-.0286-.3811.1185-.4081.3286-.2872 2.234-1.3341 5.968-3.1397 11.1847-.0689.199.0276.4196.2155.4925.188.073.3962-.0292.4651-.2283Z"
        />
      </svg>
    );
  }
  const [loading, setLoading] = useState<boolean>(true);

  async function testData() {
    const data = await fetch(
      "https://www.cha.go.kr/cha/openapi/selectEventListOpenapi.do?searchYear=2024&searchMonth=6"
    );
    const text = await data.text();
    const result = await parseStringPromise(text);
    const items = [];
    for (let i = 0; i < 43; i++) {
      items.push({
        seqNo: result.result.item[i].seqNo[0],
        subTitle: result.result.item[i].subTitle[0],
        eDate: `${result.result.item[i].eDate[0].slice(
          0,
          4
        )}.${result.result.item[i].eDate[0].slice(4, 6)}.${result.result.item[
          i
        ].eDate[0].slice(6, 8)}`,
        imageUrl: `/festivalPosts/${i}.jpg`,
      });
    }

    setFestivalItems(items);
    setLoading(false); // 데이터 로딩 완료
  }
  useEffect(() => {
    testData();
  }, []);

  // 날짜 변경
  const defaultDate = dayjs("2024-06-01"); // 2024년 6월 1일 생성
  const [selectedDate, setSelectedDate] = useState(defaultDate);
  const [message, setMessage] = useState<string>("행사를 가져오는 중입니다...");

  const handlePreviousMonth = () => {
    const newDate = selectedDate.subtract(1, "month");
    setSelectedDate(newDate);
  };

  const handleNextMonth = () => {
    const newDate = selectedDate.add(1, "month");
    setSelectedDate(newDate);
    console.log(currentData);
    if (currentData.length === 0) {
      setMessage("이번달 행사는 없습니다");
    }
  };

  useEffect(() => {
    const filteredData = festivalItems.filter((item) => {
      const itemDate = item.eDate.slice(0, 7);
      const formatDate = selectedDate.format("YYYY.MM");
      return formatDate === itemDate;
    });
    setCurrentData(filteredData);
  }, [selectedDate, festivalItems]);

  return (
    <>
      {/* 상단 및 날짜 선택 등 기타 컴포넌트 */}
      <div className="flex flex-row gap-11 mt-8 w-full h-[340px]">
        {/* 날짜 조회 */}
        <div className="flex flex-col justify-center items-center w-[10%]">
          <button onClick={handleNextMonth} className="w-11">
            <ChevronUpIcon className="size-11 text-black" />
          </button>
          <span className="text-black text-xl">
            {selectedDate.format("YYYY.MM")}
          </span>
          <button onClick={handlePreviousMonth} className="w-11">
            <ChevronDownIcon className="size-11 text-black" />
          </button>
        </div>
        {/* 행사 카드 */}
        <div className="w-[85%] h-[340px] overflow-x-auto">
          <div className="flex flex-row gap-4">
            {loading ? (
              // 데이터 로딩 중일 때
              <div className="flex flex-col gap-9 mx-auto items-center">
                <NotFound />
                <p>행사를 가져오는 중입니다...</p>
              </div>
            ) : currentData.length > 0 ? (
              // 로딩이 끝났고 데이터가 있을 때
              currentData.map((item, index) => (
                <div
                  className="flex-shrink-0 flex flex-col w-[280px] h-[320px] rounded-md shadow-[5px_5px_5px_#ccc8c8]"
                  key={index}
                  style={{
                    scrollbarWidth: "none",
                    msOverflowStyle: "none",
                  }}
                >
                  <div className="relative w-[280px] h-[230px] mb-1">
                    <Image
                      src={item.imageUrl}
                      alt=""
                      fill
                      priority
                      sizes="280px"
                      style={{
                        objectFit: "cover",
                        objectPosition: "center top",
                      }}
                    />
                  </div>
                  <div className="flex flex-col justify-center gap-3 mt-3 ml-2">
                    <span className="text-black text-base font-bold">
                      {item.subTitle}
                    </span>
                    <div className="flex flex-row items-center">
                      <span className="text-black text-xs font-bold">
                        {item.eDate}
                      </span>
                    </div>
                  </div>
                </div>
              ))
            ) : (
              // 로딩은 끝났지만 해당 월에 행사가 없을 때
              <div className="flex flex-col gap-9 mx-auto items-center">
                <NotFound />
                <p>이번달 행사는 없습니다</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </>
  );
}
